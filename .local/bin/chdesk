#!/bin/bash

# OBS.: This is experimental. You need to delete the '~/Desktop' directory


set -e

DESKDIR="$HOME/.Desktops"


# Show help message
HELP_MSG()
{
	echo -e '\nusage: chdesk [command]\n'
	echo -e 'Commands:\n'

	echo '  init - Start chdesk (move current desktop to folder with desktops)'
	echo '  list | ls - list the available desktops'
	echo '  add | make <name> - create a new desktop with the label <name>'
	echo '  cp | copy <src> <dest> - copy the <src> desktop to a new one named <name>'
	echo '  rm | remove | dell <name> - delete a desktop <name>'
	echo '  change <name> - change to the desktop with the label <name>'
	echo '  help | -h | --help - show this message'

	echo -e '\n\nError codes:'
	echo '  1: unrecognized option'
	echo '  2: wrong number of parameters'
	echo '  3: trying to create an existing desktop'
	echo '  4: non-existing desktop'
	echo '  5: trying to start chdesk, but it has already been started'
}


# Check the parameters number
#
# $1: Current number of parameters
# $2: Correct number of parameters
NUMBER_ERROR()
{
	if [[ "$1" != "$2" ]]; then
		echo -e "\nERROR! Wrong number of parameters.\n"
		exit 2
	fi
}


# Check if a Desktop exists
#
# $1: Desktop name (not the path)
DESKTOP_EXIST()
{
	ls "$DESKDIR/$1" > /dev/null 2> /dev/null && echo true || echo false
}


case "$1" in
	# Init chdesk
	init) NUMBER_ERROR $# 1
		# Does not init if it has already been started
		ls "$DESKDIR" > /dev/null 2> /dev/null && \
			{
				echo -e '\nChdesk has already been started!\n'
				exit 5
			}

		# Directory with desktops
		mkdir "$DESKDIR"

		# If the current '~/Desktop' is a link, switch by a folder
		if [[ -L ~/Desktop ]]; then
			rm ~/Desktop
			mkdir ~/Desktop
		fi

		# Move current desktop and change to it
		mv ~/Desktop "$DESKDIR/Desktop"
		$0 change Desktop
		;;

	# List all "Desktops"
	list | ls ) NUMBER_ERROR $# 1
		ls "$DESKDIR"
		declare -i VALOR=$(ls -l ~/Desktop | fgrep -o '/' | wc -l)
		VALOR=${VALOR}+1

		echo -e "\nActive: `ls -l ~/Desktop | cut -d'/' -f${VALOR}`"
		;;

	# Create a new "Desktop"
	add | make ) NUMBER_ERROR $# 2
		# Does not create if it already exists
		if [[ "$(DESKTOP_EXIST $2)" == 'true' ]]; then
			echo -e '\nThis Desktop already exists! Choose other name.\n'
			exit 3

		# Creates the new Desktop
		else
			mkdir -p "${DESKDIR}/$2"
		fi
		;;

	# Copy a existing "Desktop"
	cp | copy ) NUMBER_ERROR $# 3
		# Does not copy if the Desktop does not exist
		if [[ "$(DESKTOP_EXIST $2)" == 'false' ]]; then
			echo -e '\nThis Desktop does not exists!\n'
			exit 4
		fi

		# Does not copy if the destination already exists
		if [[ "$(DESKTOP_EXIST $3)" == 'true' ]]; then
			echo -e '\nThe destination Desktop already exists! Choose other name.\n'
			exit 3
		fi

		# Copies the Desktop
		cp -r "${DESKDIR}/$2"  "${DESKDIR}/$3"
		;;

	# Remove a existing "Desktop"
	rm | remove | dell ) NUMBER_ERROR $# 2
		# Does not delete if the Desktop does not exist
		if [[ "$(DESKTOP_EXIST $2)" == 'false' ]]; then
			echo -e '\nThis Desktop does not exists!\n'
			exit 4
		fi

		# Deletes
		rm -r "${DESKDIR}/$2"
		;;

	# Change to the "Desktop"
	change ) NUMBER_ERROR $# 2
		# Does not change if it does not exists
		if [[ "$(DESKTOP_EXIST $2)" == 'false' ]]; then
			echo -e '\nThis Desktop does not exists!\n'
			exit 4
		fi

		# Changes the Desktop
		ln -dsfT "${DESKDIR}/$2" ~/Desktop

		# Restarts the desktop (if in xfce)
		if [ "$XDG_CURRENT_DESKTOP" == 'XFCE' ]; then
			xfdesktop -Q
			xfdesktop -R &
		fi
		;;

	# Show help message
	help | -h | --help ) NUMBER_ERROR $# 1
		HELP_MSG;;

	# Error because there are no parameters
	"" ) NUMBER_ERROR $# 1;;

	# If there is no compatible option
	* )
		echo "Command: 'chdesk'; unrecognized option: '$1'"
		exit 1
		;;
esac


# vim: nobackup
